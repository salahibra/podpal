{# templates/index.html #}
{% extends "layout.html" %}

{% block title %}Accueil – PODPAL-AI{% endblock %}

{% block content %}
  

    <!-- Error Message -->
    {% if error %}
      <div class="alert alert-danger rounded-4 mb-4">{{ error }}</div>
    {% endif %}

    <!-- Main Content Area -->
    <div class="row g-4">
      <!-- Left Column - Import and Player -->
      <div class="col-lg-8">
        <!-- Import Section -->
        <div class="card border-0 shadow-sm rounded-4 mb-4 bg-light" style="background: linear-gradient(135deg, #f8f9ff 0%,rgb(253, 253, 255) 100%);">
          <div class="card-body p-5 text-center">
            <div class="mb-4">
              <div class="bg-purple rounded-circle mx-auto mb-3" style="width: 80px; height: 80px; display: flex; align-items: center; justify-content: center;">
                <i class="fas fa-cloud-upload-alt text-white" style="font-size: 2rem;"></i>
              </div>
            </div>

            <h4 class="fw-bold mb-2">Importer un Podcast</h4>
            <p class="text-muted mb-4">ou collez un lien YouTube</p>

            <div class="row justify-content-center">
              <div class="col-md-8">
                <div class="mb-3">
                  <select id="source_type" name="source_type" class="form-select form-select-lg rounded-pill">
                    <option value="" selected disabled>Choisissez votre source…</option>
                    <option value="youtube">URL YouTube</option>
                    <option value="audio_file">Fichier audio (mp3, wav)</option>
                    <option value="text_file">Fichier texte (.txt)</option>
                  </select>
                </div>

                <form method="POST" enctype="multipart/form-data">
                  <div id="youtube_div" class="mb-3 d-none">
                    <input
                      type="url"
                      id="youtube_url"
                      name="youtube_url"
                      class="form-control form-control-lg rounded-pill"
                      placeholder="https://www.youtube.com/..."
                    />
                  </div>

                  <div id="audio_div" class="mb-3 d-none">
                    <input
                      type="file"
                      id="audio_upload"
                      name="audio_upload"
                      class="form-control form-control-lg rounded-pill"
                      accept=".mp3, .wav"
                    />
                  </div>

                  <div id="text_div" class="mb-3 d-none">
                    <input
                      type="file"
                      id="text_upload"
                      name="text_upload"
                      class="form-control form-control-lg rounded-pill"
                      accept=".txt"
                    />
                  </div>

                  <input type="hidden" name="source_type" id="hidden_source_type" />
                  <button type="submit" class="btn btn-purple btn-lg rounded-pill px-5">
                    <i class="fas fa-upload me-2"></i>Importer
                  </button>
                </form>
              </div>
            </div>
          </div>
        </div>

        <!-- Audio Player Section -->
        {% if audio_filename %}
          <div class="card border-0 shadow-sm rounded-4 mb-4">
            <div class="card-body p-4">
              <div class="d-flex align-items-center mb-3">
                <div class="bg-purple rounded-3 me-3 p-2" style="width: 50px; height: 50px; display: flex; align-items: center; justify-content: center;">
                  <i class="fas fa-headphones text-white"></i>
                </div>
                <div>
                  
                </div>
              </div>

              <audio
                id="audioPlayer"
                class="w-100 mb-3"
                controls
                preload="metadata"
              >
                <source
                  src="{{ url_for('uploaded_file', filename=audio_filename) }}"
                  type="audio/{{ audio_filename.split('.')[-1] }}"
                />
                Your browser does not support the audio element.
              </audio>

              <!-- Custom Audio Controls -->
              <div class="d-flex align-items-center mb-3">
                <button class="btn btn-outline-secondary rounded-circle me-3" id="prevBtn">
                  <i class="fas fa-step-backward"></i>
                </button>
                <button class="btn btn-purple rounded-circle me-3" id="playPauseBtn" style="width: 50px; height: 50px;">
                  <i class="fas fa-play"></i>
                </button>
                <button class="btn btn-outline-secondary rounded-circle me-3" id="nextBtn">
                  <i class="fas fa-step-forward"></i>
                </button>
                <div class="flex-grow-1">
                  <div class="progress rounded-pill mb-1" style="height: 8px;">
                    <div
                      class="progress-bar bg-purple rounded-pill"
                      role="progressbar"
                      style="width: 0%;"
                      aria-valuenow="0"
                      aria-valuemin="0"
                      aria-valuemax="100"
                    ></div>
                  </div>
                  <div class="d-flex justify-content-between">
                    <small id="currentTime" class="text-muted">0:00</small>
                    <small id="totalTime" class="text-muted">0:00</small>
                  </div>
                </div>
              </div>
            </div>
          </div>
        {% endif %}

        <!-- Content Tabs -->
        <div class="card border-0 shadow-sm rounded-4">
          <div class="card-body p-0">
            <!-- Tab Navigation -->
            <div class="border-bottom px-4 pt-4">
              <ul class="nav nav-pills nav-fill" id="podcastTabs" role="tablist">
                <li class="nav-item" role="presentation">
                  <button
                    class="nav-link active rounded-pill me-2"
                    id="transcription-tab"
                    data-bs-toggle="tab"
                    data-bs-target="#transcription"
                    type="button"
                    role="tab"
                  >
                    <i class="fas fa-file-alt me-2"></i>Transcription
                  </button>
                </li>
                <li class="nav-item" role="presentation">
                  <button
                    class="nav-link rounded-pill me-2"
                    id="chapters-tab"
                    data-bs-toggle="tab"
                    data-bs-target="#chapters"
                    type="button"
                    role="tab"
                  >
                    <i class="fas fa-list me-2"></i>Chapitres
                  </button>
                </li>
                <!-- summaries for each chapter -->
                 <li class="nav-item" role="presentation">
                  <button
                    class="nav-link rounded-pill me-2"
                    id="summaries-tab"
                    data-bs-toggle="tab"
                    data-bs-target="#summaries"
                    type="button"
                    role="tab"
                  >
                    <i class="fas fa-book me-2"></i>Résumé des Chapitres
                  </button>
                </li>
                <!-- global summary -->
                <li class="nav-item" role="presentation">
                  <button
                    class="nav-link rounded-pill me-2"
                    id="global-summary-tab"
                    data-bs-toggle="tab"
                    data-bs-target="#global-summary"
                    type="button"
                    role="tab"
                  >
                    <i class="fas fa-book me-2"></i>Résumé Global
                  </button>
                </li>
                <li class="nav-item" role="presentation">
                  <button
                    class="nav-link rounded-pill"
                    id="questions-tab"
                    data-bs-toggle="tab"
                    data-bs-target="#questions"
                    type="button"
                    role="tab"
                  >
                    <i class="fas fa-comments me-2"></i>Questions
                  </button>
                </li>
              </ul>
            </div>

            <!-- Tab Content -->
            <div class="tab-content p-4" id="podcastTabsContent">
              <!-- Transcription Tab -->
              <div class="tab-pane fade show active" id="transcription" role="tabpanel">
                {% if raw_text %}
                  <div class="bg-light rounded-4 p-4" style="max-height: 500px; overflow-y: auto;">
                    <pre class="mb-0" style="white-space: pre-wrap; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;">{{ raw_text }}</pre>
                  </div>
                {% else %}
                  <div class="text-center py-5">
                    <i class="fas fa-file-alt text-muted mb-3" style="font-size: 3rem;"></i>
                    <p class="text-muted">Aucune transcription disponible. Importez un podcast.</p>
                  </div>
                {% endif %}
              </div>

              <!-- Chapters Tab -->
              <div class="tab-pane fade" id="chapters" role="tabpanel">
                <div class="mb-3">
                  <button id="chaptersButton" class="btn btn-outline-purple rounded-pill">
                    <i class="fas fa-sync me-2"></i>Charger les chapitres
                  </button>
                </div>
                <div class="row">
                  <div class="col-md-4">
                    <ul id="chaptersList" class="list-group list-group-flush">
                      {% if not raw_text %}
                        <li class="list-group-item border-0 text-muted">
                          Importez un podcast pour voir les chapitres.
                        </li>
                      {% endif %}
                    </ul>
                  </div>
                  <div class="col-md-8">
                    <div id="chapterContent" class="bg-light rounded-4 p-4" style="min-height: 300px;">
                      {% if not raw_text %}
                        <div class="text-center py-5">
                          <i class="fas fa-book-open text-muted mb-3" style="font-size: 2rem;"></i>
                          <em class="text-muted">Sélectionnez un chapitre pour voir son contenu.</em>
                        </div>
                      {% else %}
                        <div class="text-center py-5">
                          <i class="fas fa-book-open text-muted mb-3" style="font-size: 2rem;"></i>
                          <em class="text-muted">Choisissez un chapitre dans la liste à gauche.</em>
                        </div>
                      {% endif %}
                    </div>
                  </div>
                </div>
              </div>
              <!-- summary for each Chapter Tab -->
              <div class="tab-pane fade" id="summaries" role="tabpanel">
                <div class="mb-3">
                  <button id="summariesButton" class="btn btn-outline-purple rounded-pill">
                    <i class="fas fa-sync me-2"></i>Charger les résumés
                  </button>
                </div>
                <div class="row">
                  <div class="col-md-4">
                    <ul id="summariesList" class="list-group list-group-flush">
                      {% if not raw_text %}
                        <li class="list-group-item border-0 text-muted">
                          Importez un podcast pour voir les résumés.
                        </li>
                      {% endif %}
                    </ul>
                  </div>
                  <div class="col-md-8">
                    <div id="summaryContent" class="bg-light rounded-4 p-4" style="min-height: 300px;">
                      {% if not raw_text %}
                        <div class="text-center py-5">
                          <i class="fas fa-book-open text-muted mb-3" style="font-size: 2rem;"></i>
                          <em class="text-muted">Sélectionnez un résumé pour voir son contenu.</em>
                        </div>
                      {% else %}
                        <div class="text-center py-5">
                          <i class="fas fa-book-open text-muted mb-3" style="font-size: 2rem;"></i>
                          <em class="text-muted">Choisissez un résumé dans la liste à gauche.</em>
                        </div>
                      {% endif %}
                    </div>
                  </div>
                </div>
              </div>
              <!-- Global Summary Tab -->
              <div class="tab-pane fade" id="global-summary" role="tabpanel">
                <div class="mb-3">
                  <button id="globalSummaryButton" class="btn btn-outline-purple rounded-pill">
                    <i class="fas fa-sync me-2"></i>résumé global
                  </button>
                </div>
                <div id="global-summary-content" class="bg-light rounded-4 p-4" style="min-height: 300px;">
                  <p class="text-muted text-center">Cliquez sur le bouton pour charger le résumé global.</p>
                </div>
              </div>
              <!-- Questions Tab -->
              <div class="tab-pane fade" id="questions" role="tabpanel">
                <!-- Chat Window -->
                <div id="chatWindow" class="chat-window bg-light rounded-4 p-4 mb-4" style="height: 400px; overflow-y: auto;">
                  {% if not rag_ready %}
                    <div class="d-flex mb-3">
                      <div class="bg-white rounded-4 p-3 shadow-sm" style="max-width: 80%;">
                        <p class="mb-2">Importez un podcast pour activer le Chatbot RAG.</p>
                      </div>
                    </div>
                  {% else %}
                    <div class="d-flex mb-3">
                      <div class="bg-white rounded-4 p-3 shadow-sm" style="max-width: 80%;">
                        <!--<p class="mb-2">Questions suggérées :</p>
                        <div class="d-flex flex-wrap gap-2">
                          <span class="badge bg-light text-dark rounded-pill px-3 py-2 suggested-question" style="cursor: pointer;">"Quels sont les principaux défis éthiques de l'IA ?"</span>
                          <span class="badge bg-light text-dark rounded-pill px-3 py-2 suggested-question" style="cursor: pointer;">"Comment l'IA va-t-elle impacter le marché du travail ?"</span>
                          <span class="badge bg-light text-dark rounded-pill px-3 py-2 suggested-question" style="cursor: pointer;">"Quelles sont les applications concrètes de l'IA aujourd'hui ?"</span>
                        </div>-->
                      </div>
                    </div>
                  {% endif %}
                </div>

                <!-- Question Input -->
                <div class="d-flex gap-3">
                  <input
                    type="text"
                    id="questionInput"
                    class="form-control form-control-lg rounded-pill"
                    placeholder="Posez votre question sur le contenu…"
                    {% if not rag_ready %} disabled {% endif %}
                  />
                  <button
                    id="askButton"
                    class="btn btn-purple rounded-circle"
                    style="width: 50px; height: 50px;"
                    {% if not rag_ready %} disabled {% endif %}
                  >
                    <i class="fas fa-paper-plane"></i>
                  </button>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Right Column - Recommended Podcasts -->
<div class="col-lg-4">
  <div class="card border-0 shadow-sm rounded-4">
    <div class="card-body p-4">
      <h5 class="fw-bold mb-4">Podcasts Recommandés</h5>

      <!-- Bouton pour charger les recommandations -->
      <div class="mb-3">
        <button id="recommendButton" class="btn btn-outline-purple rounded-pill w-100">
          <i class="fas fa-sync me-2"></i>Charger les recommandations
        </button>
      </div>

      <!-- Conteneur où seront injectées les recommandations -->
      <div id="recommendationsList">
        {% if not raw_text %}
          <div class="text-muted py-3 text-center">
            Importez un podcast pour voir les recommandations.
          </div>
        {% endif %}
      </div>
    </div>
  </div>
</div>


  <!-- Custom Inline Styles (you can move to static/css/styles.css if preferred) -->
  <style>
   :root {
  /* Primary Colors - Blue Theme */
  --blue-primary: #3B82F6;
  --blue-light: #60A5FA;
  --blue-dark: #2563EB;
  --blue-gradient: linear-gradient(135deg, #3B82F6 0%, #1E40AF 100%);
  
  
  
  /* Enhanced Gradients */
  --gradient-ocean: linear-gradient(135deg, #3B82F6 0%, #1E40AF 50%, #1E3A8A 100%);
  --gradient-sky: linear-gradient(135deg, #0EA5E9 0%, #3B82F6 50%, #1E40AF 100%);
  
  
  
  /* Glass Effect */
 
  
  /* Shadows */
  --shadow-md: 0 4px 6px -1px rgba(59, 130, 246, 0.1);
  --shadow-lg: 0 10px 15px -3px rgba(59, 130, 246, 0.1);
  --shadow-xl: 0 20px 25px -5px rgba(59, 130, 246, 0.1);
  --shadow-glow: 0 0 20px rgba(59, 130, 246, 0.3);
  
  /* Animation */
  --transition-fast: 0.15s cubic-bezier(0.4, 0, 0.2, 1);
  --transition-normal: 0.3s cubic-bezier(0.4, 0, 0.2, 1);
  --transition-bounce: 0.4s cubic-bezier(0.68, -0.55, 0.265, 1.55);
}

/* Global Styles */
* {
  margin: 0;
  padding: 0;
  box-sizing: border-box;
}

body {
  background: linear-gradient(135deg,rgb(255, 255, 255) 0%, #EFF6FF 50%,rgb(240, 245, 250) 100%);

  min-height: 100vh;
  font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
  color: var(--blue-800);
  position: relative;
  padding-bottom: 0px; /* Space for fixed footer */
}

/* Animated Background */
body::before {
  content: '';
  position: fixed;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background: 
    
  animation: backgroundMove 20s ease-in-out infinite;
  pointer-events: none;
  z-index: -1;
}

@keyframes backgroundMove {
  0%, 100% { transform: translateX(0) translateY(0); }
  50% { transform: translateX(-20px) translateY(-10px); }
}

/* Main Container - 80% Width - Auto apply to body content */
body > * {
  max-width: 100%;
  margin-left: auto;
  margin-right: auto;
}

.main-container {
  max-width: 80%;
  margin: 0 auto;
  padding: 2rem;
  position: relative;
  z-index: 1;
}

/* Container overrides for Bootstrap */
.container, 
.container-fluid, 
.container-sm, 
.container-md, 
.container-lg, 
.container-xl, 
.container-xxl {
  max-width: 80% !important;
  margin: 0 auto !important;
  padding-left: 2rem;
  padding-right: 2rem;
}

/* Header Styles */
.header-section {
  backdrop-filter: blur(25px);
  background: var(--glass-bg);
  border: 1px solid var(--glass-border);
  border-radius: 24px;
  box-shadow: var(--shadow-lg);
  padding: 2rem;
  margin-bottom: 2rem;
  position: relative;
  overflow: hidden;
}

.header-section::before {
  content: '';
  position: absolute;
  top: 0;
  left: -100%;
  width: 100%;
  height: 100%;
  background: linear-gradient(90deg, transparent, rgba(59, 130, 246, 0.1), transparent);
  animation: shimmer 3s infinite;
}

@keyframes shimmer {
  0% { left: -100%; }
  100% { left: 100%; }
}

/* Card Styles */
.card {
  backdrop-filter: blur(25px);
  background: rgb(253, 253, 253);
  border: 1px solid var(--glass-border);
  box-shadow: var(--shadow-xl);
  transition: all var(--transition-bounce);
  border-radius: 24px;
  margin: 1rem 0;
  position: relative;
  overflow: hidden;
}

.card::before {
  content: '';
  position: absolute;
  top: 0;
  left: 0;
  right: 0;
  height: 4px;
  background: var(--gradient-ocean);
  transform: scaleX(0);
  transition: transform var(--transition-normal);
}

.card:hover::before {
  transform: scaleX(1);
}

.card:hover {
  transform: translateY(-8px) scale(1.02);
  box-shadow: var(--shadow-xl), var(--shadow-glow);
}

/* Import Section */
.import-section {
  background: linear-gradient(135deg, rgba(255, 255, 255, 0.9) 0%, rgba(239, 246, 255, 0.8) 100%);
  backdrop-filter: blur(25px);
  border: 1px solid var(--glass-border);
  border-radius: 24px;
  padding: 3rem;
  margin: 2rem 0;
  position: relative;
}

/* Button Styles */
.btn-purple {
  background: var(--gradient-ocean);
  border: none;
  color: white;
  transition: all var(--transition-bounce);
  box-shadow: var(--shadow-lg);
  border-radius: 50px;
  padding: 1rem 2rem;
  font-weight: 600;
  text-transform: uppercase;
  letter-spacing: 1px;
  position: relative;
  overflow: hidden;
}

.btn-purple::after {
  content: '';
  position: absolute;
  top: 50%;
  left: 50%;
  width: 0;
  height: 0;
  background: rgba(255, 255, 255, 0.3);
  border-radius: 50%;
  transform: translate(-50%, -50%);
  transition: all var(--transition-normal);
}

.btn-purple:hover::after {
  width: 300px;
  height: 300px;
}

.btn-purple:hover {
  transform: translateY(-3px) scale(1.05);
  box-shadow: var(--shadow-xl), var(--shadow-glow);
}

.btn-outline-purple {
  border: 2px solid var(--blue-primary);
  color: var(--blue-primary);
  background: rgba(59, 130, 246, 0.05);
  backdrop-filter: blur(15px);
  transition: all var(--transition-bounce);
  border-radius: 50px;
  padding: 1rem 2rem;
  font-weight: 600;
  position: relative;
  overflow: hidden;
}

.btn-outline-purple::before {
  content: '';
  position: absolute;
  top: 0;
  left: 0;
  width: 0;
  height: 100%;
  background: var(--gradient-ocean);
  transition: width var(--transition-normal);
  z-index: -1;
}

.btn-outline-purple:hover::before {
  width: 100%;
}

.btn-outline-purple:hover {
  color: white;
  border-color: transparent;
  transform: translateY(-3px) scale(1.05);
  box-shadow: var(--shadow-xl), var(--shadow-glow);
}

/* Form Controls */
.form-control, .form-select {
  border: 2px solid rgba(255, 255, 255, 0.3);
  background: rgba(255, 255, 255, 0.9);
  backdrop-filter: blur(15px);
  transition: all var(--transition-normal);
  box-shadow: var(--shadow-md);
  border-radius: 16px;
  padding: 1rem;
  font-size: 1.1rem;
}

.form-control:focus, .form-select:focus {
  border-color: var(--blue-primary);
  box-shadow: 0 0 0 4px rgba(59, 130, 246, 0.15);
  background: rgba(255, 255, 255, 1);
  transform: translateY(-2px);
}

/* Navigation Pills */
.nav-pills {
  background: rgba(255, 255, 255, 0.8);
  backdrop-filter: blur(15px);
  border-radius: 50px;
  padding: 8px;
  border: 1px solid var(--glass-border);
  display: flex;
  flex-wrap: wrap;
  gap: 8px;
}

.nav-pills .nav-link {
  color: var(--blue-700);
  border-radius: 50px;
  transition: all var(--transition-bounce);
  font-weight: 600;
  padding: 1rem 1.5rem;
  flex: 1;
  text-align: center;
  position: relative;
  overflow: hidden;
}

.nav-pills .nav-link.active {
  background: var(--gradient-ocean);
  color: white;
  box-shadow: var(--shadow-lg);
  transform: scale(1.05);
}

.nav-pills .nav-link:hover:not(.active) {
  background: rgba(59, 130, 246, 0.1);
  color: var(--blue-primary);
  transform: translateY(-2px);
}

/* Chat Components */
.chat-window {
  background: linear-gradient(135deg, rgba(255, 255, 255, 0.15) 0%, rgba(255, 255, 255, 0.08) 100%);
  backdrop-filter: blur(25px);
  border: 1px solid rgba(255, 255, 255, 0.3);
  border-radius: 24px;
  padding: 2rem;
  margin: 1rem 0;
  min-height: 400px;
}

.chat-bubble-user {
  background-color: #2563EB;    /* pick any hex/variable you like */
  color: white;
  border-radius: 1rem;
  padding: 1rem;
  max-width: 80%;
  /* optional shadow to match your theme */
  box-shadow: 0 .125rem .25rem rgba(0,0,0,.075);
}

.chat-bubble-bot {
  background: rgba(255, 255, 255, 0.95);
  backdrop-filter: blur(15px);
  border: 1px solid rgba(255, 255, 255, 0.4);
  box-shadow: var(--shadow-lg);
  border-radius: 20px;
  padding: 1.5rem;
  margin: 1rem 0;
  max-width: 80%;
}

/* Progress Bar */
.progress {
  background: rgba(255, 255, 255, 0.3);
  border-radius: 50px;
  overflow: hidden;
  height: 12px;
}

.progress-bar {
  background: var(--gradient-ocean);
  transition: width var(--transition-normal);
  border-radius: 50px;
}

/* Alerts */
.alert {
  backdrop-filter: blur(15px);
  border: 2px solid rgba(255, 255, 255, 0.4);
  border-radius: 16px;
  padding: 1.5rem;
  margin: 1rem 0;
}

.alert-danger {
  background: rgba(239, 68, 68, 0.15);
  color: #DC2626;
  border-color: rgba(239, 68, 68, 0.4);
}

.alert-info {
  background: rgba(59, 130, 246, 0.15);
  color: #2563EB;
  border-color: rgba(59, 130, 246, 0.4);
}

/* Fixed Footer */
.footer {
  position: fixed;
  bottom: 0;
  left: 0;
  right: 0;
  background: var(--glass-bg);
  backdrop-filter: blur(25px);
  border-top: 1px solid var(--glass-border);
  padding: 1rem 0;
  text-align: center;
  color: var(--blue-700);
  font-weight: 500;
  z-index: 1000;
  box-shadow: 0 -4px 6px -1px rgba(59, 130, 246, 0.1);
}

/* List Items */
.chapter-item, .summary-item {
  border: 1px solid rgba(255, 255, 255, 0.3);
  background: rgba(255, 255, 255, 0.1);
  backdrop-filter: blur(15px);
  transition: all var(--transition-bounce);
  border-radius: 16px;
  margin: 0.5rem 0;
  padding: 1.5rem;
}

.chapter-item:hover, .summary-item:hover {
  background: rgba(59, 130, 246, 0.15);
  border-color: var(--blue-primary);
  transform: translateX(8px) scale(1.02);
  box-shadow: var(--shadow-lg);
}

/* Suggestions */
.suggested-question {
  background: rgba(255, 255, 255, 0.9);
  color: var(--blue-700);
  border: 2px solid rgba(255, 255, 255, 0.4);
  backdrop-filter: blur(15px);
  transition: all var(--transition-bounce);
  border-radius: 50px;
  padding: 1rem 1.5rem;
  margin: 0.5rem;
  font-weight: 500;
  position: relative;
  overflow: hidden;
}

.suggested-question::before {
  content: '';
  position: absolute;
  top: 0;
  left: 0;
  width: 0;
  height: 100%;
  background: var(--gradient-ocean);
  transition: width var(--transition-normal);
  z-index: -1;
}

.suggested-question:hover::before {
  width: 100%;
}

.suggested-question:hover {
  color: white;
  transform: translateY(-3px) scale(1.05);
  box-shadow: var(--shadow-xl);
}

/* Scrollbar */
::-webkit-scrollbar {
  width: 12px;
}

::-webkit-scrollbar-track {
  background: rgba(255, 255, 255, 0.1);
  border-radius: 10px;
}

::-webkit-scrollbar-thumb {
  background: var(--gradient-ocean);
  border-radius: 10px;
  border: 2px solid rgba(255, 255, 255, 0.1);
}

/* Responsive Design */
@media (max-width: 768px) {
  .main-container {
    max-width: 95%;
    padding: 1rem;
  }
  
  .nav-pills {
    flex-direction: column;
  }
  
  .nav-pills .nav-link {
    margin-bottom: 8px;
    min-width: 100%;
  }
  
  .btn-purple, .btn-outline-purple {
    width: 100%;
    margin-bottom: 15px;
  }
  
  .chat-bubble-user, .chat-bubble-bot {
    max-width: 95%;
  }
  
  .header-section, .import-section, .chat-window {
    padding: 1.5rem;
  }
}

@media (max-width: 480px) {
  .main-container {
    max-width: 98%;
    padding: 0.5rem;
  }
  
  .header-section, .import-section, .chat-window {
    padding: 1rem;
  }
}

/* Utility Classes */
.text-blue {
  color: var(--blue-primary);
}

.bg-blue {
  background: var(--gradient-ocean);
}

.shadow-glass {
  box-shadow: var(--shadow-lg);
}

/* Animation Classes */
.fade-in {
  animation: fadeIn 0.6s ease-out;
}

@keyframes fadeIn {
  from { opacity: 0; transform: translateY(20px); }
  to { opacity: 1; transform: translateY(0); }
}

.floating {
  animation: floating 6s ease-in-out infinite;
}

@keyframes floating {
  0%, 100% { transform: translateY(0px); }
  50% { transform: translateY(-10px); }
}
  </style>
{% endblock %}


{% block scripts %}
<script>
document.addEventListener("DOMContentLoaded", function() {
  // --- 1) Affichage conditionnel des champs d'import --- #
  const sourceSelect = document.getElementById("source_type");
  const youtubeDiv   = document.getElementById("youtube_div");
  const audioDiv     = document.getElementById("audio_div");
  const textDiv      = document.getElementById("text_div");
  const hiddenType   = document.getElementById("hidden_source_type");

  sourceSelect.addEventListener("change", function() {
    youtubeDiv.classList.add("d-none");
    audioDiv.classList.add("d-none");
    textDiv.classList.add("d-none");

    const val = this.value;
    hiddenType.value = val;

    if (val === "youtube") {
      youtubeDiv.classList.remove("d-none");
    } else if (val === "audio_file") {
      audioDiv.classList.remove("d-none");
    } else if (val === "text_file") {
      textDiv.classList.remove("d-none");
    }
  });

  // --- 2) Custom Audio Player Controls --- #
  const audioPlayer = document.getElementById("audioPlayer");
  const playPauseBtn = document.getElementById("playPauseBtn");
  const progressBar = document.querySelector(".progress-bar");
  const currentTimeEl = document.getElementById("currentTime");
  const totalTimeEl = document.getElementById("totalTime");

  if (audioPlayer && playPauseBtn) {
    // Une fois les métadonnées chargées, on montre le lecteur et on met à jour la durée totale
    audioPlayer.addEventListener("loadedmetadata", function() {
      audioPlayer.classList.remove("d-none");
      const formatTime = t => {
        const m = Math.floor(t / 60);
        const s = Math.floor(t % 60).toString().padStart(2, "0");
        return `${m}:${s}`;
      };
      totalTimeEl.textContent = formatTime(audioPlayer.duration);
    });

    playPauseBtn.addEventListener("click", function() {
      if (audioPlayer.paused) {
        audioPlayer.play();
        playPauseBtn.innerHTML = '<i class="fas fa-pause"></i>';
      } else {
        audioPlayer.pause();
        playPauseBtn.innerHTML = '<i class="fas fa-play"></i>';
      }
    });

    audioPlayer.addEventListener("timeupdate", function() {
      const pct = (audioPlayer.currentTime / audioPlayer.duration) * 100;
      progressBar.style.width = pct + "%";

      const formatTime = t => {
        const m = Math.floor(t / 60);
        const s = Math.floor(t % 60).toString().padStart(2, "0");
        return `${m}:${s}`;
      };

      currentTimeEl.textContent = formatTime(audioPlayer.currentTime);
    });

    audioPlayer.addEventListener("ended", function() {
      playPauseBtn.innerHTML = '<i class="fas fa-play"></i>';
    });
  }

  // --- 3) Chapitres (GET /get_chapters) --- #
  const chaptersBtn = document.getElementById("chaptersButton");
  if (chaptersBtn) {
    const chaptersList   = document.getElementById("chaptersList");
    const chapterContent = document.getElementById("chapterContent");

    chaptersBtn.addEventListener("click", function() {
      chaptersBtn.disabled = true;
      chaptersBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Chargement…';

      fetch("/get_chapters")
        .then(res => res.json())
        .then(data => {
          // Si l’API renvoie une erreur
          if (data.error) {
            chaptersList.innerHTML = `<li class="list-group-item text-danger border-0">${data.error}</li>`;
            chaptersBtn.disabled = false;
            chaptersBtn.innerHTML = '<i class="fas fa-sync me-2"></i>Charger les chapitres';
            return;
          }

          // Aucun chapitre retourné (tableau vide)
          if (!Array.isArray(data.chapters) || data.chapters.length === 0) {
            chaptersList.innerHTML = `
              <li class="list-group-item text-muted border-0">
                Aucun chapitre disponible. Importez d’abord un podcast.
              </li>`;
            chaptersBtn.disabled = false;
            chaptersBtn.innerHTML = '<i class="fas fa-sync me-2"></i>Charger les chapitres';
            return;
          }

          // Affichage des chapitres retrouvés
          let html = "";
          data.chapters.forEach(chap => {
            html += `
              <li class="list-group-item chapter-item border-0 rounded-3 mb-2" data-index="${chap.index}" style="cursor: pointer;">
                <i class="fas fa-play-circle me-2 text-purple"></i>${chap.title}
              </li>`;
          });
          chaptersList.innerHTML = html;
          chaptersBtn.disabled = false;
          chaptersBtn.innerHTML = '<i class="fas fa-sync me-2"></i>Recharger les chapitres';

          // Ajout des écouteurs de clic pour chaque chapitre
          document.querySelectorAll(".chapter-item").forEach(el => {
            el.addEventListener("click", function() {
              // Surbrillance de l’élément sélectionné
              document.querySelectorAll(".chapter-item").forEach(item => item.classList.remove("bg-light"));
              this.classList.add("bg-light");

              const idx = this.dataset.index;
              fetch(`/get_chapter_content/${idx}`)
                .then(resp => resp.json())
                .then(respData => {
                  if (respData.error) {
                    chapterContent.innerHTML = `<div class="alert alert-danger rounded-4">${respData.error}</div>`;
                    return;
                  }
                  chapterContent.innerHTML = `
                    <h5 class="fw-bold mb-3">${data.chapters[idx].title}</h5>
                    <p class="lh-lg">${respData.content}</p>
                  `;
                })
                .catch(err => {
                  console.error(err);
                  chapterContent.innerHTML = `<div class="alert alert-danger rounded-4">Erreur chargement chapitre.</div>`;
                });
            });
          });
        })
        .catch(err => {
          console.error(err);
          chaptersList.innerHTML = `<li class="list-group-item text-danger border-0">Erreur réseau.</li>`;
          chaptersBtn.disabled = false;
          chaptersBtn.innerHTML = '<i class="fas fa-sync me-2"></i>Charger les chapitres';
        });
    });
  }

  // --- 4) Résumés de chaque chapitre (GET /get_summaries) --- #
  const summariesBtn = document.getElementById("summariesButton");
  if (summariesBtn) {
    const summariesList   = document.getElementById("summariesList");
    const summaryContent = document.getElementById("summaryContent");

    summariesBtn.addEventListener("click", function() {
      summariesBtn.disabled = true;
      summariesBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Chargement…';

      fetch("/get_summaries")
        .then(res => res.json())
        .then(data => {
          // Si l’API renvoie une erreur
          if (data.error) {
            summariesList.innerHTML = `<li class="list-group-item text-danger border-0">${data.error}</li>`;
            summariesBtn.disabled = false;
            summariesBtn.innerHTML = '<i class="fas fa-sync me-2"></i>Charger les résumés';
            return;
          }

          // Aucun résumé retourné (tableau vide)
          if (!Array.isArray(data.summaries) || data.summaries.length === 0) {
            summariesList.innerHTML = `
              <li class="list-group-item text-muted border-0">
                Aucun résumé disponible. Importez d’abord un podcast.
              </li>`;
            summariesBtn.disabled = false;
            summariesBtn.innerHTML = '<i class="fas fa-sync me-2"></i>Charger les résumés';
            return;
          }

          // Affichage des résumés retrouvés
          let html = "";
          data.summaries.forEach(summary => {
            html += `
              <li class="list-group-item summary-item border-0 rounded-3 mb-2" data-index="${summary.index}" style="cursor: pointer;">
                <i class="fas fa-file-alt me-2 text-purple"></i>${summary.title}
              </li>`;
          });
          summariesList.innerHTML = html;
          summariesBtn.disabled = false;
          summariesBtn.innerHTML = '<i class="fas fa-sync me-2"></i>Recharger les résumés';

          // Ajout des écouteurs de clic pour chaque résumé
          document.querySelectorAll(".summary-item").forEach(el => {
            el.addEventListener("click", function() {
              // Surbrillance de l’élément sélectionné
              document.querySelectorAll(".summary-item").forEach(item => item.classList.remove("bg-light"));
              this.classList.add("bg-light");

              const idx = this.dataset.index;
              fetch(`/get_summary_content/${idx}`)
                .then(resp => resp.json())
                .then(respData => {
                  if (respData.error) {
                    summaryContent.innerHTML = `<div class="alert alert-danger rounded-4">${respData.error}</div>`;
                    return;
                  }
                  summaryContent.innerHTML = `
                    <h5 class="fw-bold mb-3">${data.summaries[idx].title}</h5>
                    <p class="lh-lg">${respData.summary}</p>
                  `;
                })
                .catch(err => {
                  console.error(err);
                  summaryContent.innerHTML = `<div class="alert alert-danger rounded-4">Erreur chargement résumé.</div>`;
                });
            });
          });
        })
        .catch(err => {
          console.error(err);
          summariesList.innerHTML = `<li class="list-group-item text-danger border-0">Erreur réseau.</li>`;
          summariesBtn.disabled = false;
          summariesBtn.innerHTML = '<i class="fas fa-sync me-2"></i>Charger les résumés';
        });
    });
  }
  

  // --- 5) Resumé global (GET /get_global_summary) --- #
  const globalSummaryButton = document.getElementById("globalSummaryButton");
  const globalSummaryContent = document.getElementById("global-summary-content");

  globalSummaryButton.addEventListener("click", function() {
    globalSummaryButton.disabled = true;
    globalSummaryButton.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Chargement…';

    fetch("/get_global_summary")
      .then(res => res.json())
      .then(data => {
        if (data.error) {
          globalSummaryContent.innerHTML = `<div class="alert alert-danger rounded-4">${data.error}</div>`;
          return;
        }
        globalSummaryContent.innerHTML = `
          <h5 class="fw-bold mb-3">Résumé Global</h5>
          <p class="lh-lg">${data.global_summary}</p>
        `;
      })
      .catch(err => {
        console.error(err);
        globalSummaryContent.innerHTML = `<div class="alert alert-danger rounded-4">Erreur chargement résumé global.</div>`;
      })
      .finally(() => {
        globalSummaryButton.disabled = false;
        globalSummaryButton.innerHTML = '<i class="fas fa-sync me-2"></i>Charger le résumé global';
      });
  });

  // --- 6) RAG Chat (POST /rag_chat) --- #
  const askBtn = document.getElementById("askButton");
  const questionInput = document.getElementById("questionInput");
  const chatWindow = document.getElementById("chatWindow");

  // Si l’utilisateur clique sur une question suggérée
  document.querySelectorAll(".suggested-question").forEach(btn => {
    btn.addEventListener("click", function() {
      questionInput.value = this.textContent.replace(/"/g, '');
      askBtn.click();
    });
  });

  // Appuyer sur “Entrée” envoie la question
  if (questionInput) {
    questionInput.addEventListener("keypress", function(e) {
      if (e.key === "Enter" && !askBtn.disabled) {
        askBtn.click();
      }
    });
  }

  if (askBtn) {
    askBtn.addEventListener("click", function() {
      const question = questionInput.value.trim();
      if (!question) {
        return;
      }

      // Afficher la bulle utilisateur
      const userMessage = document.createElement("div");
      userMessage.className = "d-flex justify-content-end mb-3";
      userMessage.innerHTML = `
        <div class="chat-bubble-user rounded-4 p-3">
          <p class="mb-0">${question}</p>
        </div>

      `;
      chatWindow.appendChild(userMessage);
      chatWindow.scrollTop = chatWindow.scrollHeight;

      askBtn.disabled = true;
      askBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
      questionInput.value = "";

      fetch("/rag_chat", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ question }),
      })
        .then(res => res.json().then(data => ({ status: res.status, body: data })))
        .then(({ status, body }) => {
          const botMessage = document.createElement("div");
          botMessage.className = "d-flex mb-3";

          if (status !== 200) {
            botMessage.innerHTML = `
              <div class="bg-danger text-white rounded-4 p-3" style="max-width: 80%;">
                <p class="mb-0">${body.error || "Erreur."}</p>
              </div>
            `;
          } else {
            let sourcesHtml = "";
            if (body.sources && body.sources.length) {
              sourcesHtml = `
                <div class="mt-2 pt-2 border-top">
                  <small class="text-muted">Sources: ${body.sources
                    .map(src => `<code class="small">${src}</code>`)
                    .join(", ")}</small>
                </div>
              `;
            }

            botMessage.innerHTML = `
              <div class="bg-white rounded-4 p-3 shadow-sm" style="max-width: 80%;">
                <p class="mb-0 lh-lg">${body.answer}</p>
                ${sourcesHtml}
              </div>`;
          }

          chatWindow.appendChild(botMessage);
          chatWindow.scrollTop = chatWindow.scrollHeight;
          askBtn.disabled = false;
          askBtn.innerHTML = '<i class="fas fa-paper-plane"></i>';
        })
        .catch(err => {
          console.error(err);
          const errorMsg = document.createElement("div");
          errorMsg.className = "d-flex mb-3";
          errorMsg.innerHTML = `
            <div class="bg-danger text-white rounded-4 p-3" style="max-width: 80%;">
              <p class="mb-0">Erreur réseau.</p>
            </div>`;
          chatWindow.appendChild(errorMsg);
          chatWindow.scrollTop = chatWindow.scrollHeight;
          askBtn.disabled = false;
          askBtn.innerHTML = '<i class="fas fa-paper-plane"></i>';
        });
    });
  }
});
document.addEventListener("DOMContentLoaded", function() {
  const recommendButton = document.getElementById("recommendButton");
  const recommendationsList = document.getElementById("recommendationsList");

  if (!recommendButton) return;

  recommendButton.addEventListener("click", function() {
    // Désactiver le bouton et afficher l’icône de chargement
    recommendButton.disabled = true;
    recommendButton.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Chargement…';

    fetch("/get_recommendations")
      .then(res =>
        res.json().then(data => ({ status: res.status, body: data }))
      )
      .then(({ status, body }) => {
        // En cas d’erreur renvoyée par l’API
        if (status !== 200) {
          recommendationsList.innerHTML = `
            <div class="alert alert-danger rounded-4">
              ${body.error || "Une erreur est survenue."}
            </div>
          `;
          recommendButton.disabled = false;
          recommendButton.innerHTML = '<i class="fas fa-sync me-2"></i>Recharger les recommandations';
          return;
        }

        // Si la liste est vide
        if (!Array.isArray(body.recommendations) || body.recommendations.length === 0) {
          recommendationsList.innerHTML = `
            <div class="text-muted py-3 text-center">
              Aucune recommandation disponible.
            </div>
          `;
          recommendButton.disabled = false;
          recommendButton.innerHTML = '<i class="fas fa-sync me-2"></i>Recharger les recommandations';
          return;
        }

        // Sinon, on construit chaque carte de recommandation
        let html = "";
        body.recommendations.forEach(rec => {
          html += `
            <a href="${rec.episode_link}" target="_blank"
               class="list-group-item list-group-item-action mb-2 rounded-4 shadow-sm">
              <div class="d-flex w-100 justify-content-between">
                <h6 class="mb-1">
                  ${rec.podcast_title}
                  <small class="text-muted">– ${rec.episode_title}</small>
                </h6>
                <small class="text-muted">${rec.score.toFixed(2)}</small>
              </div>
              <!--<p class="mb-0 text-truncate">${rec.description}</p>-->
            </a>
          `;
        });

        // On injecte le HTML dans le conteneur
        recommendationsList.innerHTML = `<div class="list-group">${html}</div>`;

        // Réactiver le bouton
        recommendButton.disabled = false;
        recommendButton.innerHTML = '<i class="fas fa-sync me-2"></i>Recharger les recommandations';
      })
      .catch(err => {
        console.error(err);
        recommendationsList.innerHTML = `
          <div class="alert alert-danger rounded-4">Erreur réseau.</div>
        `;
        recommendButton.disabled = false;
        recommendButton.innerHTML = '<i class="fas fa-sync me-2"></i>Recharger les recommandations';
      });
  });
});
</script>
{% endblock %}